<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.nmgns.bps.dktj.dao.InterestShareInfoDao">

    <!-- 机构利息时点 -->
    <select id="findOrgLoanInterest" parameterType="org.nmgns.bps.dktj.entity.InterestShareInfo" resultType="org.nmgns.bps.dktj.entity.InterestShareInfo">
        SELECT
            a.date,
            a.ln_org_code,
            t.name AS template_name,
            p.name AS position_name,
            sum(a.balance) AS balance,
            lno.name AS ln_org_name,
            a.belong_org_code,
            blo.name AS belong_org_name,
            #{queryType} AS query_type
        FROM
            t_dktj_employee_interest_share a
            LEFT JOIN t_sys_organization lno ON a.ln_org_code = lno.code
            LEFT JOIN t_sys_organization blo ON a.belong_org_code = blo.code
            LEFT JOIN t_dktj_template t ON a.template_id = t.id
            LEFT JOIN t_dktj_position p ON a.position_id = p.id
        <where>
            <if test="startDate != null">
                date >= #{startDate}
            </if>
             <if test="endDate != null">
                 AND date &lt;= #{endDate}
             </if>
            <choose>
                <!-- 核心系统利息 -->
                <when test='queryType != null and queryType == "1"'>
                    AND ( lno.id = #{organizationId} OR lno.parent_ids @> CAST(ARRAY[#{organizationId}] AS INTEGER[]))
                </when>
                <!-- 汇总利息 -->
                <when test='queryType != null and queryType == "2"'>
                    AND (blo.id = #{organizationId} OR blo.parent_ids @> CAST(ARRAY[#{organizationId}] AS INTEGER[]))
                </when>
                <!-- 调入利息 -->
                <when test='queryType != null and queryType == "3"'>
                    AND ( (lno.id != #{organizationId} AND NOT lno.parent_ids @> CAST(ARRAY[#{organizationId}] AS INTEGER[])) AND
                    (blo.id = #{organizationId} OR blo.parent_ids @> CAST(ARRAY[#{organizationId}] AS INTEGER[])) )
                </when>
                <!-- 调出利息 -->
                <when test='queryType != null and queryType == "4"'>
                    AND ( (lno.id = #{organizationId} OR lno.parent_ids @> CAST(ARRAY[#{organizationId}] AS INTEGER[])) AND
                    (blo.id != #{organizationId} AND NOT blo.parent_ids @> CAST(ARRAY[#{organizationId}] AS INTEGER[])) )
                </when>
            </choose>

            <!-- 数据范围过滤 -->
            ${sqlMap.dsf}
        </where>
        GROUP BY a.ln_org_code,a.belong_org_code,a.date,lno.name,blo.name,#{queryType},t.name,p.name HAVING sum(a.balance) != 0
        <choose>
            <when test="page !=null and page.sorters != null">
                ORDER BY
                <foreach collection="page.sorters" item="sorter" index="index" separator=",">
                    ${sorter.property} ${sorter.direction}
                </foreach>
            </when>
            <otherwise>
                ORDER BY a.date DESC, a.ln_org_code ASC, a.belong_org_code ASC
            </otherwise>
        </choose>
    </select>

    <!-- 机构汇总利息 -->
    <select id="findOrgAvgLoanInterest" parameterType="org.nmgns.bps.dktj.entity.InterestShareInfo" resultType="org.nmgns.bps.dktj.entity.InterestShareInfo">
        SELECT
        a.ln_org_code,
        t.name AS template_name,
        p.name AS position_name,
--         round(sum(a.balance)/${avgDays},2) AS balance,
        sum(a.balance) AS balance,
        lno.name AS ln_org_name,
        a.belong_org_code,
        blo.name AS belong_org_name,
        #{queryType} AS query_type,
        ${avgDays} AS avg_days,
        #{startDate} AS start_date,
        #{endDate} AS end_date
        FROM
        t_dktj_employee_interest_share a
        LEFT JOIN t_sys_organization lno ON a.ln_org_code = lno.code
        LEFT JOIN t_sys_organization blo ON a.belong_org_code = blo.code
        LEFT JOIN t_dktj_template t ON a.template_id = t.id
        LEFT JOIN t_dktj_position p ON a.position_id = p.id
        <where>
            <if test="startDate != null">
                AND <![CDATA[ a.date >= #{startDate} ]]>
            </if>
            <if test="endDate != null">
                AND <![CDATA[ a.date <= #{endDate} ]]>
            </if>
            <choose>
                <!-- 核心系统利息 -->
                <when test='queryType != null and queryType == "1"'>
                    AND ( lno.id = #{organizationId} OR lno.parent_ids @> CAST(ARRAY[#{organizationId}] AS INTEGER[]))
                </when>
                <!-- 汇总利息 -->
                <when test='queryType != null and queryType == "2"'>
                    AND (blo.id = #{organizationId} OR blo.parent_ids @> CAST(ARRAY[#{organizationId}] AS INTEGER[]))
                </when>
                <!-- 调入利息 -->
                <when test='queryType != null and queryType == "3"'>
                    AND ( (lno.id != #{organizationId} AND NOT lno.parent_ids @> CAST(ARRAY[#{organizationId}] AS INTEGER[])) AND
                    (blo.id = #{organizationId} OR blo.parent_ids @> CAST(ARRAY[#{organizationId}] AS INTEGER[])) )
                </when>
                <!-- 调出利息 -->
                <when test='queryType != null and queryType == "4"'>
                    AND ( (lno.id = #{organizationId} OR lno.parent_ids @> CAST(ARRAY[#{organizationId}] AS INTEGER[])) AND
                    (blo.id != #{organizationId} AND NOT blo.parent_ids @> CAST(ARRAY[#{organizationId}] AS INTEGER[])) )
                </when>
            </choose>
            <!-- 数据范围过滤 -->
            ${sqlMap.dsf}
        </where>
        GROUP BY a.ln_org_code,a.belong_org_code,lno.name,blo.name,#{queryType},t.name,p.name,#{startDate},#{endDate} HAVING sum(a.balance) != 0
        <choose>
            <when test="page !=null and page.sorters != null">
                ORDER BY
                <foreach collection="page.sorters" item="sorter" index="index" separator=",">
                    ${sorter.property} ${sorter.direction}
                </foreach>
            </when>
            <otherwise>
                ORDER BY a.ln_org_code ASC, a.belong_org_code ASC
            </otherwise>
        </choose>
    </select>

    <!-- 员工时点利息 -->
    <select id="findEmployeeLoanInterest" parameterType="org.nmgns.bps.dktj.entity.InterestShareInfo" resultType="org.nmgns.bps.dktj.entity.InterestShareInfo">
        SELECT
        a.date,
        a.ln_org_code,
        a.teller_code,
        u.name AS teller_name,
        t.name AS template_name,
        p.name AS position_name,
        sum(a.balance) AS balance,
        lno.name AS ln_org_name,
        a.belong_org_code,
        blo.name AS belong_org_name,
        #{queryType} AS query_type
        FROM
        t_dktj_employee_interest_share a
        LEFT JOIN t_sys_organization lno ON a.ln_org_code = lno.code
        LEFT JOIN t_sys_organization blo ON a.belong_org_code = blo.code
        LEFT JOIN t_sys_user u ON u.code = a.teller_code
        LEFT JOIN t_dktj_template t ON a.template_id = t.id
        LEFT JOIN t_dktj_position p ON a.position_id = p.id
        <where>
            <if test="tellerCode != null and tellerCode != ''">
                AND a.teller_code = #{tellerCode}
            </if>
            <if test="tellerName != null and tellerName != ''">
                AND u.name = #{tellerName}
            </if>
            <if test="startDate != null">
                <![CDATA[ AND a.date >= #{startDate} ]]>
            </if>
            <if test="endDate != null">
                <![CDATA[ AND a.date <= #{endDate} ]]>
            </if>
            <choose>
                <!-- 核心系统利息 -->
                <when test='queryType != null and queryType == "1"'>
                    AND ( lno.id = #{organizationId} OR lno.parent_ids @> CAST(ARRAY[#{organizationId}] AS INTEGER[]))
                </when>
                <!-- 汇总利息 -->
                <when test='queryType != null and queryType == "2"'>
                    AND (blo.id = #{organizationId} OR blo.parent_ids @> CAST(ARRAY[#{organizationId}] AS INTEGER[]))
                </when>
                <!-- 调入利息 -->
                <when test='queryType != null and queryType == "3"'>
                    AND ( (lno.id != #{organizationId} AND NOT lno.parent_ids @> CAST(ARRAY[#{organizationId}] AS INTEGER[])) AND
                    (blo.id = #{organizationId} OR blo.parent_ids @> CAST(ARRAY[#{organizationId}] AS INTEGER[])) )
                </when>
                <!-- 调出利息 -->
                <when test='queryType != null and queryType == "4"'>
                    AND ( (lno.id = #{organizationId} OR lno.parent_ids @> CAST(ARRAY[#{organizationId}] AS INTEGER[])) AND
                    (blo.id != #{organizationId} AND NOT blo.parent_ids @> CAST(ARRAY[#{organizationId}] AS INTEGER[])) )
                </when>
            </choose>
            <!-- 数据范围过滤 -->
            ${sqlMap.dsf}
        </where>
        GROUP BY a.ln_org_code,a.belong_org_code,a.date,lno.name,blo.name,#{queryType},a.teller_code,u.name,t.name,p.name HAVING sum(a.balance) != 0
        <choose>
            <when test="page !=null and page.sorters != null">
                ORDER BY
                <foreach collection="page.sorters" item="sorter" index="index" separator=",">
                    ${sorter.property} ${sorter.direction}
                </foreach>
            </when>
            <otherwise>
                ORDER BY a.date DESC, a.ln_org_code ASC, a.belong_org_code ASC
            </otherwise>
        </choose>
    </select>

    <!-- 员工汇总利息 -->
    <select id="findEmployeeAvgLoanInterest" parameterType="org.nmgns.bps.dktj.entity.InterestShareInfo" resultType="org.nmgns.bps.dktj.entity.InterestShareInfo">
        SELECT
        a.ln_org_code,
        a.teller_code,
        u.name AS teller_name,
        t.name AS template_name,
        p.name AS position_name,
--         round(sum(a.balance)/${avgDays},2) AS balance,
        sum(a.balance) AS balance,
        lno.name AS ln_org_name,
        a.belong_org_code,
        blo.name AS belong_org_name,
        #{queryType} AS query_type,
        ${avgDays} AS avg_days,
        #{startDate} AS start_date,
        #{endDate} AS end_date
        FROM
        t_dktj_employee_interest_share a
        LEFT JOIN t_sys_organization lno ON a.ln_org_code = lno.code
        LEFT JOIN t_sys_organization blo ON a.belong_org_code = blo.code
        LEFT JOIN t_sys_user u ON u.code = a.teller_code
        LEFT JOIN t_dktj_template t ON a.template_id = t.id
        LEFT JOIN t_dktj_position p ON a.position_id = p.id
        <where>
            <if test="startDate != null">
                date >= #{startDate}
            </if>
            <if test="endDate != null">
                AND date &lt;= #{endDate}
            </if>
            <if test="tellerCode != null and tellerCode != '' ">
                AND a.teller_code = #{tellerCode}
            </if>
            <choose>
                <!-- 核心系统利息 -->
                <when test='queryType != null and queryType == "1"'>
                    AND ( lno.id = #{organizationId} OR lno.parent_ids @> CAST(ARRAY[#{organizationId}] AS INTEGER[]))
                </when>
                <!-- 汇总利息 -->
                <when test='queryType != null and queryType == "2"'>
                    AND (blo.id = #{organizationId} OR blo.parent_ids @> CAST(ARRAY[#{organizationId}] AS INTEGER[]))
                </when>
                <!-- 调入利息 -->
                <when test='queryType != null and queryType == "3"'>
                    AND ( (lno.id != #{organizationId} AND NOT lno.parent_ids @> CAST(ARRAY[#{organizationId}] AS INTEGER[])) AND
                    (blo.id = #{organizationId} OR blo.parent_ids @> CAST(ARRAY[#{organizationId}] AS INTEGER[])) )
                </when>
                <!-- 调出利息 -->
                <when test='queryType != null and queryType == "4"'>
                    AND ( (lno.id = #{organizationId} OR lno.parent_ids @> CAST(ARRAY[#{organizationId}] AS INTEGER[])) AND
                    (blo.id != #{organizationId} AND NOT blo.parent_ids @> CAST(ARRAY[#{organizationId}] AS INTEGER[])) )
                </when>
            </choose>
            <!-- 数据范围过滤 -->
            ${sqlMap.dsf}
        </where>
        GROUP BY a.ln_org_code,a.belong_org_code,lno.name,blo.name,#{queryType},a.teller_code,u.name,t.name,p.name,#{startDate},#{endDate} HAVING sum(a.balance) != 0
        <choose>
            <when test="page !=null and page.sorters != null">
                ORDER BY
                <foreach collection="page.sorters" item="sorter" index="index" separator=",">
                    ${sorter.property} ${sorter.direction}
                </foreach>
            </when>
            <otherwise>
                ORDER BY  a.ln_org_code ASC, a.belong_org_code ASC
            </otherwise>
        </choose>
    </select>

    <!-- 利息明细总个数 -->
    <select id="findCount" parameterType="org.nmgns.bps.dktj.entity.InterestShareInfo" resultType="java.lang.Long">
        SELECT count(*)
        FROM
            t_dktj_employee_interest_share a
            LEFT JOIN t_sys_organization lno ON a.ln_org_code = lno.code
            LEFT JOIN t_sys_organization blo ON a.belong_org_code = blo.code
            LEFT JOIN t_dktj_template t ON a.template_id = t.id
            LEFT JOIN t_dktj_position p ON a.position_id = p.id
            LEFT JOIN (SELECT cust_id,c_name FROM t_ods_dul_t01_cr_prvt_ip_inf_h UNION ALL SELECT cust_id,c_name FROM t_ods_dul_t01_cr_corp_ip_inf_h) i ON i.cust_id = a.xd_customer_no
        <where>
            <if test="organizationId != null" >
                AND (lno.id = #{organizationId} OR lno.parent_ids @> CAST(ARRAY[#{organizationId}] AS INTEGER[]))
            </if>
            <if test="startDate != null">
               AND <![CDATA[ a.date >= #{startDate} ]]>
            </if>
            <if test="endDate != null">
                AND <![CDATA[ a.date <= #{endDate} ]]>
            </if>
            <if test="tellerCode != null and tellerCode != ''">
                AND a.teller_code = #{tellerCode}
            </if>
            <if test="accountNo != null and accountNo != ''">
                AND a.account_no = #{accountNo}
            </if>
            <if test="xdCustomerNo != null and xdCustomerNo != ''">
                AND a.xd_customer_no = #{xdCustomerNo}
            </if>
            <if test="lnOrgCode != null and lnOrgCode != ''">
                AND a.ln_org_code = #{lnOrgCode}
            </if>
            <if test="belongOrgCode != null and belongOrgCode != ''">
                AND a.belong_org_code = #{belongOrgCode}
            </if>
            <!-- 数据范围过滤 -->
            ${sqlMap.dsf}
        </where>
    </select>

    <!-- 利息明细 -->
    <select id="findList" resultType="org.nmgns.bps.dktj.entity.InterestShareInfo">
        SELECT
            a.*,
            lno.name AS ln_org_name,
            blo.name AS belong_org_name,
            t.name AS template_name,
            p.name AS position_name,
            i.c_name AS customer_name
        FROM
            t_dktj_employee_interest_share a
        LEFT JOIN t_sys_organization lno ON a.ln_org_code = lno.code
        LEFT JOIN t_sys_organization blo ON a.belong_org_code = blo.code
        LEFT JOIN t_dktj_template t ON a.template_id = t.id
        LEFT JOIN t_dktj_position p ON a.position_id = p.id
        LEFT JOIN (SELECT cust_id,c_name FROM t_ods_dul_t01_cr_prvt_ip_inf_h UNION ALL SELECT cust_id,c_name FROM t_ods_dul_t01_cr_corp_ip_inf_h) i ON i.cust_id = a.xd_customer_no
        <where>
            <if test="organizationId != null" >
                AND (lno.id = #{organizationId} OR lno.parent_ids @> CAST(ARRAY[#{organizationId}] AS INTEGER[]))
            </if>
            <if test="startDate != null">
                AND a.date >= #{startDate}
            </if>
            <if test="endDate != null">
                AND a.date &lt;= #{endDate}
            </if>
            <if test="tellerCode != null and tellerCode != ''">
                AND a.teller_code = #{tellerCode}
            </if>
            <if test="accountNo != null and accountNo != ''">
                AND a.account_no = #{accountNo}
            </if>
            <if test="xdCustomerNo != null and xdCustomerNo != ''">
                AND a.xd_customer_no = #{xdCustomerNo}
            </if>
            <if test="lnOrgCode != null and lnOrgCode != ''">
                AND a.ln_org_code = #{lnOrgCode}
            </if>
            <if test="belongOrgCode != null and belongOrgCode != ''">
                AND a.belong_org_code = #{belongOrgCode}
            </if>
            <!-- 数据范围过滤 -->
            ${sqlMap.dsf}
        </where>
        <choose>
            <when test="page !=null and page.sorters != null">
                ORDER BY
                <foreach collection="page.sorters" item="sorter" index="index" separator=",">
                    ${sorter.property} ${sorter.direction}
                </foreach>
            </when>
            <otherwise>
                ORDER BY a.date DESC, a.ln_org_code ASC, a.teller_code ASC
            </otherwise>
        </choose>
        <if test="page != null and page.start >= 0 and page.pageSize > 0">
            offset ${page.start} limit ${page.pageSize}
        </if>
    </select>

    <select id="findUnboundReaddAccountCount" parameterType="org.nmgns.bps.dktj.entity.EmployeeInterest" resultType="java.lang.Long">
        SELECT
            count(*)
        FROM
        t_dktj_unbound_employee_interest a
        LEFT JOIN t_dktj_employee_customer ec ON a.account_no = ec.account_no AND a.org_code = ec.org_code AND ec.valid_flag = TRUE
        LEFT JOIN t_sys_organization o ON a.org_code = o.code
        <where>
            a.del_flag = FALSE
            <if test="organizationId != null" >
                AND (o.id = #{organizationId} OR o.parent_ids @> CAST(ARRAY[#{organizationId}] AS INTEGER[]))
            </if>
            <if test="customerName != null and customerName != ''">
                AND a.customer_name = #{customerName}
            </if>
            <if test="accountNo != null and accountNo != ''">
                AND a.account_no = #{accountNo}
            </if>
            <if test="orgCode != null and orgCode != ''">
                AND a.org_code = #{orgCode}
            </if>
            <if test="xdCustomerNo != null and xdCustomerNo != ''">
                AND a.xd_customer_no = #{xdCustomerNo}
            </if>
            <if test="identityNo != null and identityNo != ''">
                AND a.identity_no = #{identityNo}
            </if>
            <!-- 数据范围过滤 -->
            ${sqlMap.dsf}
        </where>
    </select>

    <!-- 获取待补录的贷款账号列表 -->
    <select id="findUnboundReaddAccount" parameterType="org.nmgns.bps.dktj.entity.EmployeeInterest" resultType="org.nmgns.bps.dktj.entity.EmployeeInterest">
        SELECT
            a.*,
            ec.teller_code AS teller_code,
            o.name AS org_name
        FROM
            t_dktj_unbound_employee_interest a
            LEFT JOIN t_dktj_employee_customer ec ON a.account_no = ec.account_no AND a.org_code = ec.org_code AND ec.valid_flag = TRUE
            LEFT JOIN t_sys_organization o ON a.org_code = o.code
        <where>
            a.del_flag = FALSE
            <if test="organizationId != null" >
                AND (o.id = #{organizationId} OR o.parent_ids @> CAST(ARRAY[#{organizationId}] AS INTEGER[]))
            </if>
            <if test="customerName != null and customerName != ''">
                AND a.customer_name = #{customerName}
            </if>
            <if test="accountNo != null and accountNo != ''">
                AND a.account_no = #{accountNo}
            </if>
            <if test="orgCode != null and orgCode != ''">
                AND a.org_code = #{orgCode}
            </if>
            <if test="xdCustomerNo != null and xdCustomerNo != ''">
                AND a.xd_customer_no = #{xdCustomerNo}
            </if>
            <if test="identityNo != null and identityNo != ''">
                AND a.identity_no = #{identityNo}
            </if>
            <!-- 数据范围过滤 -->
            ${sqlMap.dsf}
        </where>
        <choose>
            <when test="page !=null and page.sorters != null">
                ORDER BY
                <foreach collection="page.sorters" item="sorter" index="index" separator=",">
                    ${sorter.property} ${sorter.direction}
                </foreach>
            </when>
            <otherwise>
                ORDER BY a.org_code ASC, a.account_open_date DESC
            </otherwise>
        </choose>
        <if test="page != null and page.start >= 0 and page.pageSize > 0">
            offset ${page.start} limit ${page.pageSize}
        </if>
    </select>

    <select id="getReaddAccountInfoByAccountNo" parameterType="org.nmgns.bps.dktj.entity.EmployeeInterest" resultType="org.nmgns.bps.dktj.entity.EmployeeInterest">
        SELECT
            a.*
        FROM
            t_dktj_unbound_employee_interest a
        WHERE account_no = #{accountNo} AND org_code = #{orgCode} AND del_flag = FALSE
    </select>

    <!-- 补录后删除待补录的信息 -->
    <update id="deleteReaddAccountById" parameterType="java.lang.Long">
        UPDATE t_dktj_unbound_employee_interest SET del_flag = TRUE WHERE id = #{id}
    </update>

    <select id="getValidEmployeeAccountCount" parameterType="org.nmgns.bps.dktj.entity.EmployeeCustomer" resultType="java.lang.Integer">
        SELECT count(*) FROM t_dktj_employee_customer WHERE org_code = #{orgCode} AND account_no = #{accountNo} AND valid_flag = TRUE
    </select>

    <select id="getEmployeeAccountCount" parameterType="org.nmgns.bps.dktj.entity.EmployeeCustomer" resultType="java.lang.Integer">
        SELECT count(*) FROM t_dktj_employee_customer WHERE org_code = #{orgCode} AND account_no = #{accountNo}
    </select>

    <select id="getCurrentValidEmployeeCustomerTellerCode" parameterType="org.nmgns.bps.dktj.entity.EmployeeCustomer" resultType="java.lang.String">
        SELECT teller_code FROM t_dktj_employee_customer WHERE org_code = #{orgCode} AND account_no = #{accountNo} AND valid_flag = TRUE
    </select>

    <!-- 获取岗位责任的账户信息（含岗位、模板） -->
    <select id="getValidPositionTellerList" parameterType="org.nmgns.bps.dktj.entity.InterestShareInfo" resultType="org.nmgns.bps.dktj.entity.InterestShareInfo">
        SELECT
            s.teller_code,s.start_date,s.id,
            dat.account_no,
            dat.org_code AS ln_org_code,
            u.name AS teller_name,
            i.c_name AS customer_name,
            i.cust_id AS xd_customer_no,
            t.name AS template_name,
            p.name AS position_name,
            p.changeable AS position_changeable,
            p.type AS position_type
        FROM
            t_dktj_account_share_info s
            LEFT JOIN t_dktj_account_template dat ON s.account_template_id = dat.id
            LEFT JOIN t_dktj_template t ON dat.template_id = t.id
            LEFT JOIN t_dktj_template_detail td ON s.template_detail_id = td.id
            LEFT JOIN t_dktj_position p ON td.position_id = p.id
            LEFT JOIN t_sys_user u ON s.teller_code = u.code
            LEFT JOIN t_sys_organization lno ON dat.org_code = lno.code
            LEFT JOIN (SELECT loan_account,cust_id,c_name FROM t_ods_t03_loancrd_inf_h WHERE date = (SELECT max(date) FROM t_ods_t03_loancrd_inf_h)) i ON i.loan_account = dat.account_no
        <where>
            s.valid_flag = TRUE AND dat.valid_flag = TRUE
            <if test="organizationId != null" >
                AND (lno.id = #{organizationId} OR lno.parent_ids @> CAST(ARRAY[#{organizationId}] AS INTEGER[]))
            </if>
            <if test="tellerCode != null and tellerCode != ''">
                AND s.teller_code = #{tellerCode}
            </if>
            <if test="accountNo != null and accountNo != ''">
                AND dat.account_no = #{accountNo}
            </if>
            <if test="xdCustomerNo != null and xdCustomerNo != ''">
                AND i.cust_id = #{xdCustomerNo}
            </if>
            <if test="customerName != null and customerName != ''">
                AND i.c_name = #{customerName}
            </if>
            <if test="lnOrgCode != null and lnOrgCode != ''">
                AND dat.org_code = #{lnOrgCode}
            </if>
            <if test="position != null and position.id != null">
                AND p.id = #{position.id}
            </if>
            <!-- 数据范围过滤 -->
            ${sqlMap.dsf}
        </where>
        <choose>
            <when test="page !=null and page.sorters != null">
                ORDER BY
                <foreach collection="page.sorters" item="sorter" index="index" separator=",">
                    ${sorter.property} ${sorter.direction}
                </foreach>
            </when>
            <otherwise>
                ORDER BY dat.org_code ASC, dat.account_no DESC,p.id ASC
            </otherwise>
        </choose>
        <if test="page != null and page.start >= 0 and page.pageSize > 0">
            offset ${page.start} limit ${page.pageSize}
        </if>
    </select>

    <select id="getValidPositionTellerListCount" parameterType="org.nmgns.bps.dktj.entity.InterestShareInfo" resultType="java.lang.Long">
        SELECT
            count(*)
        FROM
        t_dktj_account_share_info s
        LEFT JOIN t_dktj_account_template dat ON s.account_template_id = dat.id
        LEFT JOIN t_dktj_template t ON dat.template_id = t.id
        LEFT JOIN t_dktj_template_detail td ON s.template_detail_id = td.id
        LEFT JOIN t_dktj_position p ON td.position_id = p.id
        LEFT JOIN t_sys_user u ON s.teller_code = u.code
        LEFT JOIN t_sys_organization lno ON dat.org_code = lno.code
        LEFT JOIN (SELECT loan_account,cust_id,c_name FROM t_ods_t03_loancrd_inf_h WHERE date = (SELECT max(date) FROM t_ods_t03_loancrd_inf_h)) i ON i.loan_account = dat.account_no
        <where>
            s.valid_flag = TRUE AND dat.valid_flag = TRUE
            <if test="organizationId != null" >
                AND (lno.id = #{organizationId} OR lno.parent_ids @> CAST(ARRAY[#{organizationId}] AS INTEGER[]))
            </if>
            <if test="tellerCode != null and tellerCode != ''">
                AND s.teller_code = #{tellerCode}
            </if>
            <if test="accountNo != null and accountNo != ''">
                AND dat.account_no = #{accountNo}
            </if>
            <if test="xdCustomerNo != null and xdCustomerNo != ''">
                AND i.cust_id = #{xdCustomerNo}
            </if>
            <if test="customerName != null and customerName != ''">
                AND i.c_name = #{customerName}
            </if>
            <if test="lnOrgCode != null and lnOrgCode != ''">
                AND dat.org_code = #{lnOrgCode}
            </if>
            <if test="position != null and position.id != null">
                AND p.id = #{position.id}
            </if>
            <!-- 数据范围过滤 -->
            ${sqlMap.dsf}
        </where>
    </select>

    <!-- 根据id获取完整的、生效的分成信息 -->
    <select id="getAccountShareInfoById" parameterType="java.lang.Long" resultType="org.nmgns.bps.dktj.entity.InterestShareInfo">
        SELECT
            s.teller_code,
            s.start_date,
            s.id,
            s.valid_flag,
            s.account_template_id,
            s.template_detail_id,
            s.parent_id,
            s.alter_check_status,
            dat.account_no,
            dat.org_code AS ln_org_code,
            t.name AS template_name,
            p.name AS position_name,
            p.changeable AS position_changeable,
            p.type AS position_type
        FROM
            t_dktj_account_share_info s
            LEFT JOIN t_dktj_account_template dat ON s.account_template_id = dat.id
            LEFT JOIN t_dktj_template t ON dat.template_id = t.id
            LEFT JOIN t_dktj_template_detail td ON s.template_detail_id = td.id
            LEFT JOIN t_dktj_position p ON td.position_id = p.id
        WHERE s.id = #{id}
    </select>

    <!-- 获取变更岗位责任人、且未复核的分成信息 -->
    <select id="getAlterUncheckedShareInfo" parameterType="org.nmgns.bps.dktj.entity.InterestShareInfo" resultType="org.nmgns.bps.dktj.entity.InterestShareInfo">
        SELECT
            s.teller_code,
            u.name AS teller_name,
            s.start_date,
            s.id,
            s.account_template_id,
            s.template_detail_id,
            i.c_name AS customer_name,
            i.cust_id AS xd_customer_no,
            dat.account_no,
            dat.org_code AS ln_org_code,
            t.name AS template_name,
            p.name AS position_name,
            p.changeable AS position_changeable,
            p.type AS position_type,
            os.teller_code AS old_teller_code,
            ou.name AS old_teller_name
        FROM
            t_dktj_account_share_info s
            LEFT JOIN t_dktj_account_template dat ON s.account_template_id = dat.id AND dat.valid_flag = TRUE
            LEFT JOIN t_dktj_template t ON dat.template_id = t.id
            LEFT JOIN t_dktj_template_detail td ON s.template_detail_id = td.id
            LEFT JOIN t_dktj_position p ON td.position_id = p.id
            LEFT JOIN t_sys_user u ON s.teller_code = u.code
            LEFT JOIN t_dktj_account_share_info os ON s.parent_id = os.id
            LEFT JOIN t_sys_user ou ON os.teller_code = ou.code
            LEFT JOIN t_sys_organization lno ON dat.org_code = lno.code
            LEFT JOIN (SELECT loan_account,cust_id,c_name FROM t_ods_t03_loancrd_inf_h WHERE date = (SELECT max(date) FROM t_ods_t03_loancrd_inf_h)) i ON i.loan_account = dat.account_no
        <where>
            s.alter_check_status = #{CHECK_STATUS_UNCHECKED}
            <if test="organizationId != null" >
                AND (lno.id = #{organizationId} OR lno.parent_ids @> CAST(ARRAY[#{organizationId}] AS INTEGER[]))
            </if>
            <if test="tellerCode != null and tellerCode != ''">
                AND s.teller_code = #{tellerCode}
            </if>
            <if test="accountNo != null and accountNo != ''">
                AND dat.account_no = #{accountNo}
            </if>
            <if test="xdCustomerNo != null and xdCustomerNo != ''">
                AND i.cust_id = #{xdCustomerNo}
            </if>
            <if test="customerName != null and customerName != ''">
                AND i.c_name = #{customerName}
            </if>
            <if test="lnOrgCode != null and lnOrgCode != ''">
                AND dat.org_code = #{lnOrgCode}
            </if>
            <if test="position != null and position.id != null">
                AND p.id = #{position.id}
            </if>
            <!-- 数据范围过滤 -->
            ${sqlMap.dsf}
        </where>
        <choose>
            <when test="page !=null and page.sorters != null">
                ORDER BY
                <foreach collection="page.sorters" item="sorter" index="index" separator=",">
                    ${sorter.property} ${sorter.direction}
                </foreach>
            </when>
            <otherwise>
                ORDER BY dat.org_code ASC, dat.account_no DESC
            </otherwise>
        </choose>
        <if test="page != null and page.start >= 0 and page.pageSize > 0">
            offset ${page.start} limit ${page.pageSize}
        </if>
    </select>

    <select id="getAlterUncheckedShareInfoCount" parameterType="org.nmgns.bps.dktj.entity.InterestShareInfo" resultType="java.lang.Long">
        SELECT
            count(*)
        FROM
        t_dktj_account_share_info s
        LEFT JOIN t_dktj_account_template dat ON s.account_template_id = dat.id AND dat.valid_flag = TRUE
        LEFT JOIN t_dktj_template t ON dat.template_id = t.id
        LEFT JOIN t_dktj_template_detail td ON s.template_detail_id = td.id
        LEFT JOIN t_dktj_position p ON td.position_id = p.id
        LEFT JOIN t_sys_user u ON s.teller_code = u.code
        LEFT JOIN t_dktj_account_share_info os ON s.parent_id = os.id
        LEFT JOIN t_sys_user ou ON os.teller_code = ou.code
        LEFT JOIN t_sys_organization lno ON dat.org_code = lno.code
        LEFT JOIN (SELECT loan_account,cust_id,c_name FROM t_ods_t03_loancrd_inf_h WHERE date = (SELECT max(date) FROM t_ods_t03_loancrd_inf_h)) i ON i.loan_account = dat.account_no
        <where>
            s.alter_check_status = #{CHECK_STATUS_UNCHECKED}
            <if test="organizationId != null" >
                AND (lno.id = #{organizationId} OR lno.parent_ids @> CAST(ARRAY[#{organizationId}] AS INTEGER[]))
            </if>
            <if test="tellerCode != null and tellerCode != ''">
                AND s.teller_code = #{tellerCode}
            </if>
            <if test="accountNo != null and accountNo != ''">
                AND dat.account_no = #{accountNo}
            </if>
            <if test="xdCustomerNo != null and xdCustomerNo != ''">
                AND i.cust_id = #{xdCustomerNo}
            </if>
            <if test="customerName != null and customerName != ''">
                AND i.c_name = #{customerName}
            </if>
            <if test="lnOrgCode != null and lnOrgCode != ''">
                AND dat.org_code = #{lnOrgCode}
            </if>
            <if test="position != null and position.id != null">
                AND p.id = #{position.id}
            </if>
            <!-- 数据范围过滤 -->
            ${sqlMap.dsf}
        </where>
    </select>

    <select id="getPositionList" resultType="org.nmgns.bps.dktj.entity.Position">
        SELECT id,name FROM t_dktj_position ORDER BY id;
    </select>

</mapper>