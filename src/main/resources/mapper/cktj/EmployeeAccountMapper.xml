<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="org.nmgns.bps.cktj.dao.EmployeeAccountDao">

    <!-- 获取未登记揽储人的账户的总数 -->
    <select id="findUnregisterAccountCount" resultType="java.lang.Long" parameterType="org.nmgns.bps.cktj.entity.EmployeeAccount">
        SELECT
            count(*)
        FROM
            bps_78000.t_cktj_unbound_account a
            LEFT JOIN bps_78000.t_ods_hxsj_deposit_account dpfm01 ON a.account_no = dpfm01.account_no
            LEFT JOIN public.t_sys_organization o ON o.code = a.org_code
            LEFT JOIN bps_78000.t_ods_hxsj_subject_dict s ON a.subject_no = s.no 
        <where>
            <if test="organizationId != null" >
                and (o.id = #{organizationId} OR ( o.parent_ids @> CAST(ARRAY[#{organizationId}] AS INTEGER[]) ) )
            </if>
            <if test="orgCode != null and orgCode != ''">
                AND a.org_code = #{orgCode}
            </if>
            <if test="accountOpenDate != null">
                AND <![CDATA[ a.open_date <= #{accountOpenDate} ]]>
            </if>
            <if test="accountNo != null and accountNo != ''">
                AND a.account_no = #{accountNo}
            </if>
            <if test="cardNo != null and cardNo != ''">
                AND a.card_no LIKE '%'||#{cardNo}||'%'
            </if>
            <if test="customerName != null and customerName != ''">
                AND a.customer_name LIKE '%'||#{customerName}||'%'
            </if>
            <if test="identityNo != null and identityNo != ''">
                AND a.identity_no = #{identityNo}
            </if>
            <if test="customerType != null and customerType != ''">
                AND a.customer_type = #{customerType}
            </if>
            ${sqlMap.dsf}
        </where>
    </select>

    <!-- 获取未登记揽储人的账户列表 -->
    <select id="findUnregisterAccount" resultType="org.nmgns.bps.cktj.entity.EmployeeAccount" parameterType="org.nmgns.bps.cktj.entity.EmployeeAccount">
        SELECT
            a.id as unbound_account_id,
            a.org_code,
            a.account_no,
            a.child_account_no,
            a.subject_no,
            s.c_name as subject_name,
            a.account_type,
            dpfm01.close_acct_flag ,
            a.card_no,
            a.open_date as account_open_date,
            a.customer_name,
            a.customer_no,
            a.customer_type,
            a.identity_no,
            a.identity_type,
            a.date as start_date,
            a.create_time
        FROM
            bps_78000.t_cktj_unbound_account a
            LEFT JOIN bps_78000.t_ods_hxsj_deposit_account dpfm01 ON a.account_no = dpfm01.account_no
            LEFT JOIN public.t_sys_organization o ON o.code = a.org_code
            LEFT JOIN bps_78000.t_ods_hxsj_subject_dict s ON a.subject_no = s.no
        <where>
            <if test="organizationId != null" >
                and (o.id = #{organizationId} OR ( o.parent_ids @> CAST(ARRAY[#{organizationId}] AS INTEGER[]) ) )
            </if>
            <if test="orgCode != null and orgCode != ''">
                AND a.org_code = #{orgCode}
            </if>
            <if test="accountOpenDate != null">
                AND <![CDATA[ a.open_date <= #{accountOpenDate} ]]>
            </if>
            <if test="accountNo != null and accountNo != ''">
                AND a.account_no = #{accountNo}
            </if>
            <if test="cardNo != null and cardNo != ''">
                AND a.card_no LIKE '%'||#{cardNo}||'%'
            </if>
            <if test="customerName != null and customerName != ''">
                AND a.customer_name LIKE '%'||#{customerName}||'%'
            </if>
            <if test="identityNo != null and identityNo != ''">
                AND a.identity_no = #{identityNo}
            </if>
            <if test="customerType != null and customerType != ''">
                AND a.customer_type = #{customerType}
            </if>
            ${sqlMap.dsf}
        </where>
        <choose>
            <when test="page !=null and page.orderBy != null and page.orderBy != ''">
                ORDER BY ${page.orderBy}
            </when>
            <otherwise>
                ORDER BY a.open_date DESC, a.account_no ASC
            </otherwise>
        </choose>
        <if test="page != null and page.start >= 0 and page.pageSize > 0">
            offset ${page.start} limit ${page.pageSize}
        </if>
    </select>

    <!-- 新增账户自动绑定规则 -->
    <insert id="insertAutoBindRule" parameterType="org.nmgns.bps.cktj.entity.AutoBindRule" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO bps_78000.t_cktj_auto_bind_rule(org_code, account_no, child_account_no, level, customer_no, create_by)
        VALUES (
                #{orgCode},
                #{accountNo},
                #{childAccountNo},
                #{level},
                #{customerNo},
                #{createBy}
               )
    </insert>

    <!-- 修改账户自动绑定规则 -->
    <update id="updateAutoBindRule" parameterType="org.nmgns.bps.cktj.entity.AutoBindRule">
        UPDATE bps_78000.t_cktj_auto_bind_rule
        <trim prefix="SET" suffixOverrides=",">
            <if test="orgCode != null and orgCode != ''">org_code = #{orgCode},</if>
            <if test="accountNo != null and accountNo != ''">account_no = #{accountNo},</if>
            <if test="childAccountNo != null and childAccountNo != ''">child_account_no = #{childAccountNo},</if>
            <if test="level != null and level != ''">
                <![CDATA[ level = #{level}, ]]>
            </if>
            <if test="customerNo != null and customerNo != ''">customer_no = #{customerNo},</if>
            <if test="updateBy != null">update_by = #{updateBy},</if>
            <if test="updateTime != null">update_time = #{updateTime},</if>
        </trim>
        WHERE id = #{id}
    </update>

    <!-- 通过id获取未登记账户的详细信息 -->
    <select id="getUnboundAccountInfoById" parameterType="java.lang.Long" resultType="org.nmgns.bps.cktj.entity.EmployeeAccount">
        SELECT
            a.id as unbound_account_id,
            a.org_code,
            a.account_no,
            a.child_account_no,
            a.account_type,
            a.card_no,
            a.open_date as account_open_date,
            a.customer_name,
            a.customer_no,
            a.customer_type,
            a.identity_no,
            a.identity_type,
            a.date as start_date,
            a.create_time
        FROM
            bps_78000.t_cktj_unbound_account a
        WHERE a.id = #{id}
    </select>

    <!-- 登记揽储人-任务数 -->
    <insert id="insertTask" keyProperty="id" useGeneratedKeys="true" parameterType="org.nmgns.bps.cktj.entity.EmployeeAccount">
        INSERT INTO bps_78000.t_cktj_employee_account_task(
                main_teller_teller_code,
                org_code,
                account_no,
                child_account_no,
                card_no,
                account_type,
                account_open_date,
                customer_no,
                customer_name,
                customer_type,
                identity_type,
                identity_no,
                start_date,
                end_date,
                valid_flag,
                register_type,
                register_check_status,
                alter_check_status,
                op_teller_code,
                register_check_teller_code,
                alter_check_teller_code,
                register_check_time,
                alter_check_time,
                parent_id,
                remarks,
                create_time,
                create_by
        ) VALUES(
                   #{mainTellerCode},
                  #{orgCode},
                  #{accountNo},
                  #{childAccountNo},
                  #{cardNo},
                  #{accountType},
                  #{accountOpenDate},
                  #{customerNo},
                  #{customerName},
                  #{customerType},
                  #{identityType},
                  #{identityNo},
                  #{startDate},
                  #{endDate},
                  #{validFlag},
                  #{registerType},
                  #{registerCheckStatus},
                  #{alterCheckStatus},
                  #{opTellerCode},
                  #{registerCheckTellerCode},
                  #{alterCheckTellerCode},
                  #{registerCheckTime},
                  #{alterCheckTime},
                  #{parentId},
                  #{remarks},
                  #{createTime},
                  #{createBy}
                )
    </insert>

    <!-- 登记揽储人-任务数 分成比例-->
    <insert id="insertTaskTellerPercentage" parameterType="org.nmgns.bps.cktj.entity.TellerPercentage">
        INSERT INTO bps_78000.t_cktj_employee_account_task_detail(
            emp_acct_id,
            teller_code,
            percentage,
            create_time,
            create_by
        ) VALUES
            (
             #{empAcctId},
             #{tellerCode},
             #{percentage},
             #{createTime},
             #{createBy}
            )
    </insert>

    <!-- 登记揽储人-计酬数 -->
    <insert id="insertPayment" keyProperty="id" useGeneratedKeys="true" parameterType="org.nmgns.bps.cktj.entity.EmployeeAccount">
        INSERT INTO bps_78000.t_cktj_employee_account_payment(
            main_teller_code,
            org_code,
            account_no,
            child_account_no,
            card_no,
            account_type,
            account_open_date,
            customer_no,
            customer_name,
            customer_type,
            identity_type,
            identity_no,
            start_date,
            end_date,
            valid_flag,
            register_type,
            register_check_status,
            alter_check_status,
            op_teller_code,
            register_check_teller_code,
            alter_check_teller_code,
            register_check_time,
            alter_check_time,
            parent_id,
            remarks,
            create_time,
            create_by
        ) VALUES
            (
             #{mainTellerCode},
            #{orgCode},
            #{accountNo},
            #{childAccountNo},
            #{cardNo},
            #{accountType},
            #{accountOpenDate},
            #{customerNo},
            #{customerName},
            #{customerType},
            #{identityType},
            #{identityNo},
            #{startDate},
            #{endDate},
            #{validFlag},
            #{registerType},
            #{registerCheckStatus},
            #{alterCheckStatus},
            #{opTellerCode},
            #{registerCheckTellerCode},
            #{alterCheckTellerCode},
            #{registerCheckTime},
            #{alterCheckTime},
            #{parentId},
            #{remarks},
            #{createTime},
            #{createBy}
            )
    </insert>

    <!-- 登记揽储人-计酬数 分成比例-->
    <insert id="insertPaymentTellerPercentage" parameterType="org.nmgns.bps.cktj.entity.TellerPercentage">
        INSERT INTO bps_78000.t_cktj_employee_account_payment_detail(
            emp_acct_id,
            teller_code,
            percentage,
            create_time,
            create_by
        ) VALUES
            (
                #{empAcctId},
                #{tellerCode},
                #{percentage},
                #{createTime},
                #{createBy}
            )
    </insert>
    
    <select id="getBindLevelByOrgAndFlag" parameterType="org.nmgns.bps.cktj.entity.BindLevel" resultType="org.nmgns.bps.cktj.entity.BindLevel">
        select * from bps_78000.t_cktj_bind_level where org_code = #{orgCode} and task_payment_flag = #{taskPaymentFlag}
    </select>

    <!-- 在登记揽储人后，删除未登记t_cktj_unbound_account表中信息 -->
    <delete id="deleteUnboundAccountById" parameterType="java.lang.Long">
        DELETE FROM bps_78000.t_cktj_unbound_account WHERE id = #{id}
    </delete>

    <!-- 通过Id获取揽储人任务分成信息 -->
    <select id="getEmployeeTaskById" resultType="org.nmgns.bps.cktj.entity.EmployeeAccount">
        SELECT
            ea.*
        FROM
            bps_78000.t_cktj_employee_account_task ea
        WHERE
            ea.id = #{id}
    </select>

    <!-- 通过Id获取揽储人计酬分成信息 -->
    <select id="getEmployeePaymentById" resultType="org.nmgns.bps.cktj.entity.EmployeeAccount">
        SELECT
            ea.*
        FROM
            bps_78000.t_cktj_employee_account_payment ea
        WHERE
            ea.id = #{id}
    </select>

    <!-- 获取已登记揽储人但未复核的账户总数 -->
    <select id="findRegisterUncheckedAccountCount" resultType="Long">
        SELECT count(*)
        from
            (
                SELECT
                    ea.*,
                    dpfm01.close_acct_flag
                FROM
                    bps_78000.t_cktj_employee_account_task ea
                    LEFT JOIN bps_78000.t_ods_hxsj_deposit_account dpfm01 on dpfm01.account_no = ea.account_no
                    LEFT JOIN public.t_sys_organization o ON o.code = ea.org_code
                <where>
                    ea.register_check_status = 'CHECKED_STATUS_UNCHECKED'
                    <if test="organizationId != null" >
                        and (o.id = #{organizationId} OR ( o.parent_ids @> CAST(ARRAY[#{organizationId}] AS INTEGER[]) ) )
                    </if>
                    <if test="orgCode != null and orgCode != ''">
                        AND ea.org_code = #{orgCode}
                    </if>
                    <!-- 搜索条件 -->
                    <if test="accountNo != null and accountNo != ''">
                        AND ea.account_no = #{accountNo}
                    </if>
                    <if test="cardNo != null and cardNo != ''">
                        AND ea.card_no LIKE '%'||#{cardNo}||'%'
                    </if>
                    <if test="customerName != null and customerName != ''">
                        AND ea.customer_name LIKE '%'||#{cardNo}||'%'
                    </if>
                    <if test="identityNo != null and identityNo != ''">
                        AND ea.identity_no = #{identityNo}
                    </if>
                    <if test="customerType != null and customerType != ''">
                        AND ea.customer_type = #{customerType}
                    </if>
                    <if test="accountOpenDate != null">
                        AND ea.account_open_date = #{accountOpenDate}
                    </if>
                    <!-- 数据范围过滤 -->
                    ${sqlMap.dsf}
                </where>
            ) t
    </select>

    <!-- 获取已登记揽储人但未复核的账户列表（通过任务分成表加工得到） -->
    <select id="findRegisterUncheckedAccount" resultType="org.nmgns.bps.cktj.entity.EmployeeAccount">
        SELECT
            ea.*,
            dpfm01.close_acct_flag
        FROM
            bps_78000.t_cktj_employee_account_task ea
            LEFT JOIN bps_78000.t_ods_hxsj_deposit_account dpfm01 on dpfm01.account_no = ea.account_no
            LEFT JOIN public.t_sys_organization o ON o.code = ea.org_code
        <where>
            ea.register_check_status = 'CHECKED_STATUS_UNCHECKED'
            <if test="organizationId != null" >
                and (o.id = #{organizationId} OR ( o.parent_ids @> CAST(ARRAY[#{organizationId}] AS INTEGER[]) ) )
            </if>
            <if test="orgCode != null and orgCode != ''">
                AND ea.org_code = #{orgCode}
            </if>
            <!-- 搜索条件 -->
            <if test="accountNo != null and accountNo != ''">
                AND ea.account_no = #{accountNo}
            </if>
            <if test="cardNo != null and cardNo != ''">
                AND ea.card_no LIKE '%'||#{cardNo}||'%'
            </if>
            <if test="customerName != null and customerName != ''">
                AND ea.customer_name LIKE '%'||#{cardNo}||'%'
            </if>
            <if test="identityNo != null and identityNo != ''">
                AND ea.identity_no = #{identityNo}
            </if>
            <if test="customerType != null and customerType != ''">
                AND ea.customer_type = #{customerType}
            </if>
            <if test="accountOpenDate != null">
                AND ea.account_open_date = #{accountOpenDate}
            </if>
            <!-- 数据范围过滤 -->
            ${sqlMap.dsf}
        </where>
        <choose>
            <when test="page !=null ">
                ORDER BY ea.account_no DESC
            </when>
            <otherwise>
                ORDER BY ea.account_no DESC
            </otherwise>
        </choose>
        <if test="page != null and page.start >= 0 and page.pageSize > 0">
            offset ${page.start} limit ${page.pageSize}
        </if>
    </select>
    
    <!-- 获取员工任务分成信息，参数为EmployeeAccountId -->
    <select id="getTellerTaskPercentageListByEmployeeAccountId" parameterType="org.nmgns.bps.cktj.entity.EmployeeAccount" resultType="org.nmgns.bps.cktj.entity.TellerPercentage">
        select
            ead.emp_acct_id,
            ead.teller_code,
            ead.percentage,
            ead.create_time,
            ead.create_by,
            u.name as teller_name
        from
            bps_78000.t_cktj_employee_account_task_detail ead
            LEFt JOIN public.t_sys_user u on ead.teller_code = u.code
            LEFT JOIN bps_78000.t_cktj_employee_account_task ea on ea.id = ead.emp_acct_id
        where
            ead.emp_acct_id = #{id}
            <if test="accountNo != null and accountNo != ''">
                and ea.account_no = #{accountNo}
            </if>
            <if test="registerCheckStatus != null and registerCheckStatus != ''">
                and ea.register_check_status = #{registerCheckStatus}
            </if>
            <if test="alterCheckStatus != null and alterCheckStatus != ''">
                and ea.alter_check_status = #{alterCheckStatus}
            </if>
            <if test="tellerCode != null and tellerCode != ''">
                and ead.teller_code = #{tellerCode}
            </if>
            <if test="validFlag != null ">
                and ea.valid_flag = #{validFlag}
            </if>
    </select>

    <!-- 获取员工计酬分成信息，参数为id -->
    <select id="getTellerPaymentPercentageListByEmployeeAccountId" parameterType="org.nmgns.bps.cktj.entity.EmployeeAccount" resultType="org.nmgns.bps.cktj.entity.TellerPercentage">
        select
            ead.emp_acct_id,
            ead.teller_code,
            ead.percentage,
            ead.create_time,
            ead.create_by,
            u.name as teller_name
        from
            bps_78000.t_cktj_employee_account_payment_detail ead
            LEFt JOIN public.t_sys_user u on ead.teller_code = u.code
            LEFT JOIN bps_78000.t_cktj_employee_account_payment ea on ea.id = ead.emp_acct_id
        where
            ead.emp_acct_id = #{id}
            <if test="accountNo != null and accountNo != ''">
                and ea.account_no = #{accountNo}
            </if>
            <if test="registerCheckStatus != null and registerCheckStatus != ''">
                and ea.register_check_status = #{registerCheckStatus}
            </if>
            <if test="alterCheckStatus != null and alterCheckStatus != ''">
                and ea.alter_check_status = #{alterCheckStatus}
            </if>
            <if test="tellerCode != null and tellerCode != ''">
                and ead.teller_code = #{tellerCode}
            </if>
            <if test="validFlag != null ">
                and ea.valid_flag = #{validFlag}
            </if>
    </select>

    <!-- 获取员工计酬分成信息，参数为账号、子账号 -->
    <select id="getTellerPaymentPercentageListByEmployeeAccountAndChildAccountNo" parameterType="org.nmgns.bps.cktj.entity.EmployeeAccount" resultType="org.nmgns.bps.cktj.entity.TellerPercentage">
        select
            ead.emp_acct_id,
            ead.teller_code,
            ead.percentage,
            ead.create_time,
            ead.create_by,
            u.name as teller_name
        from
            bps_78000.t_cktj_employee_account_payment_detail ead
            LEFt JOIN public.t_sys_user u on ead.teller_code = u.code
            LEFT JOIN bps_78000.t_cktj_employee_account_payment ea on ea.id = ead.emp_acct_id
        <where>
            <if test="accountNo != null and accountNo != ''">
                and ea.account_no = #{accountNo}
            </if>
            <if test="childAccountNo != null and childAccountNo != ''">
                and ea.child_account_no = #{childAccountNo}
            </if>
            <if test="registerCheckStatus != null and registerCheckStatus != ''">
                and ea.register_check_status = #{registerCheckStatus}
            </if>
            <if test="alterCheckStatus != null and alterCheckStatus != ''">
                and ea.alter_check_status = #{alterCheckStatus}
            </if>
            <if test="tellerCode != null and tellerCode != ''">
                and ead.teller_code = #{tellerCode}
            </if>
            <if test="validFlag != null ">
                and ea.valid_flag = #{validFlag}
            </if>
        </where>
    </select>

    <!-- 修改任务分成信息表 -->
    <update id="updateTaskById" parameterType="org.nmgns.bps.cktj.entity.EmployeeAccount">
        UPDATE bps_78000.t_cktj_employee_account_task
        <trim prefix="SET" suffixOverrides=",">
            <if test="mainTellerCode != null and mainTellerCode != ''">main_teller_code = #{mainTellerCode},</if>
                end_date = #{endDate},
            <if test="validFlag != null ">valid_flag = #{validFlag},</if>
            <if test="registerCheckStatus != null and registerCheckStatus != ''">register_check_status = #{registerCheckStatus},</if>
            <if test="alterCheckStatus != null and alterCheckStatus != ''">alter_check_status = #{alterCheckStatus},</if>
            <if test="registerCheckTellerCode != null and registerCheckTellerCode != ''">register_check_teller_code = #{registerCheckTellerCode},</if>
            <if test="alterCheckTellerCode != null and alterCheckTellerCode != ''">alter_check_teller_code = #{alterCheckTellerCode},</if>
            <if test="registerCheckTime != null ">register_check_time = #{registerCheckTime},</if>
            <if test="alterCheckTime != null ">alter_check_time = #{alterCheckTime},</if>
            <if test="parentId != null ">parent_id = #{parentId},</if>
            <if test="remarks != null and remarks != ''">remarks = #{remarks},</if>
            <if test="updateBy != null">update_by = #{updateBy},</if>
            <if test="updateTime != null">update_time = #{updateTime},</if>
        </trim>
        WHERE id = #{id}
    </update>

    <!-- 修改计酬分成信息表 -->
    <update id="updatePaymentById" parameterType="org.nmgns.bps.cktj.entity.EmployeeAccount">
        UPDATE bps_78000.t_cktj_employee_account_payment
        <trim prefix="SET" suffixOverrides=",">
            <if test="mainTellerCode != null and mainTellerCode != ''">main_teller_code = #{mainTellerCode},</if>
            end_date = #{endDate},
            <if test="validFlag != null ">valid_flag = #{validFlag},</if>
            <if test="registerCheckStatus != null and registerCheckStatus != ''">register_check_status = #{registerCheckStatus},</if>
            <if test="alterCheckStatus != null and alterCheckStatus != ''">alter_check_status = #{alterCheckStatus},</if>
            <if test="registerCheckTellerCode != null and registerCheckTellerCode != ''">register_check_teller_code = #{registerCheckTellerCode},</if>
            <if test="alterCheckTellerCode != null and alterCheckTellerCode != ''">alter_check_teller_code = #{alterCheckTellerCode},</if>
            <if test="registerCheckTime != null ">register_check_time = #{registerCheckTime},</if>
            <if test="alterCheckTime != null ">alter_check_time = #{alterCheckTime},</if>
            <if test="parentId != null ">parent_id = #{parentId},</if>
            <if test="remarks != null and remarks != ''">remarks = #{remarks},</if>
            <if test="updateBy != null">update_by = #{updateBy},</if>
            <if test="updateTime != null">update_time = #{updateTime},</if>
        </trim>
        WHERE id = #{id}
    </update>

    <!-- 删除任务分成信息 -->
    <delete id="deleteTask" parameterType="java.lang.Long">
        delete from bps_78000.t_cktj_employee_account_task where id = #{id}
    </delete>

    <!-- 删除任务分成比例 -->
    <delete id="deleteTaskTellerPercentage" parameterType="java.lang.Long">
        delete from bps_78000.t_cktj_employee_account_task_detail where emp_acct_id = #{id}
    </delete>

    <!-- 删除计酬分成信息 -->
    <delete id="deletePayment" parameterType="java.lang.Long">
        delete from bps_78000.t_cktj_employee_account_payment where id = #{id}
    </delete>

    <!-- 删除计酬分成比例 -->
    <delete id="deletePaymentTellerPercentage" parameterType="java.lang.Long">
        delete from bps_78000.t_cktj_employee_account_payment_detail where emp_acct_id = #{id}
    </delete>

    <!-- 新增未绑定账号，用于拒绝登记后恢复未登记记录 -->
    <insert id="insertUnboundEmployeeAccount" parameterType="org.nmgns.bps.cktj.entity.EmployeeAccount" keyProperty="id" useGeneratedKeys="true">
        INSERT INTO bps_78000.t_cktj_unbound_account
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="customerNo != null and customerNo != ''" >
                customer_no,
            </if>
            <if test="accountNo != null and accountNo != ''" >
                account_no,
            </if>
            <if test="childAccountNo != null and childAccountNo != ''" >
                child_account_no,
            </if>
            <if test="subjectNo != null and subjectNo != ''" >
                subject_no,
            </if>
            <if test="accountType != null and accountType != ''" >
                account_type,
            </if>
            <if test="cardNo != null and cardNo != ''" >
                card_no,
            </if>
            <if test="accountOpenDate != null" >
                open_date,
            </if>
            <if test="customerName != null and customerName != ''" >
                customer_name,
            </if>
            <if test="orgCode != null and orgCode != ''" >
                org_code,
            </if>
            <if test="identityType != null and identityType != ''" >
                identity_type,
            </if>
            <if test="identityNo != null and identityNo != ''" >
                identity_no,
            </if>
            <if test="customerType != null and customerType != ''" >
                customer_type,
            </if>
            <if test="startDate != null" >
                date,
            </if>
            <if test="createTime != null" >
                create_time
            </if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides="," >
            <if test="customerNo != null and customerNo != ''" >
                #{customerNo},
            </if>
            <if test="accountNo != null and accountNo != ''" >
                #{accountNo},
            </if>
            <if test="childAccountNo != null and childAccountNo != ''" >
                #{childAccountNo},
            </if>
            <if test="subjectNo != null and subjectNo != ''" >
                #{subjectNo},
            </if>
            <if test="accountType != null and accountType != ''" >
                #{accountType},
            </if>
            <if test="cardNo != null and cardNo != ''" >
                #{cardNo},
            </if>
            <if test="accountOpenDate != null" >
                #{accountOpenDate},
            </if>
            <if test="customerName != null and customerName != ''" >
                #{customerName},
            </if>
            <if test="orgCode != null and orgCode != ''" >
                #{orgCode},
            </if>
            <if test="identityType != null and identityType != ''" >
                #{identityType},
            </if>
            <if test="identityNo != null and identityNo != ''" >
                #{identityNo},
            </if>
            <if test="customerType != null and customerType != ''" >
                #{customerType},
            </if>
            <if test="startDate != null" >
                #{startDate},
            </if>
            <if test="createTime != null" >
                #{createTime}
            </if>
        </trim>
    </insert>

    <!-- 在task分成表中，通过账号、子账号获取账号的基础信息 ，用于拒绝审核时，恢复未绑定列表的内容-->
    <select id="getEmployeeAccountByAccountNoAndChildAccountNoFromTask" parameterType="org.nmgns.bps.cktj.entity.EmployeeAccount" resultType="org.nmgns.bps.cktj.entity.EmployeeAccount">
        SELECT
            ea.*,
            dpfm01.close_acct_flag
        FROM
            bps_78000.t_cktj_employee_account_task ea
            LEFT JOIN bps_78000.t_ods_hxsj_deposit_account dpfm01 on dpfm01.account_no = ea.account_no
        <where>
            <if test="registerCheckStatus != null and registerCheckStatus != ''">
                and ea.register_check_status = #{registerCheckStatus}
            </if>
            <if test="alterCheckStatus != null and alterCheckStatus != ''">
                and ea.alter_check_status = #{alterCheckStatus}
            </if>
            <if test="accountNo != null and accountNo != ''">
                and ea.account_no = #{accountNo}
            </if>
            <if test="childAccountNo != null and childAccountNo != ''">
                and ea.child_account_no = #{childAccountNo}
            </if>
            <if test="validFlag != null ">
                and ea.valid_flag = #{validFlag}
            </if>
        </where>
    </select>

    <!-- 在payment分成表中，通过账号、子账号获取账号的基础信息 ，用于拒绝审核时，恢复未绑定列表的内容-->
    <select id="getEmployeeAccountByAccountNoAndChildAccountNoFromPayment" parameterType="org.nmgns.bps.cktj.entity.EmployeeAccount" resultType="org.nmgns.bps.cktj.entity.EmployeeAccount">
        SELECT
            ea.*,
            dpfm01.close_acct_flag
        FROM
        bps_78000.t_cktj_employee_account_payment ea
        LEFT JOIN bps_78000.t_ods_hxsj_deposit_account dpfm01 on dpfm01.account_no = ea.account_no
        <where>
            <if test="registerCheckStatus != null and registerCheckStatus != ''">
                and ea.register_check_status = #{registerCheckStatus}
            </if>
            <if test="alterCheckStatus != null and alterCheckStatus != ''">
                and ea.alter_check_status = #{alterCheckStatus}
            </if>
            <if test="accountNo != null and accountNo != ''">
                and ea.account_no = #{accountNo}
            </if>
            <if test="childAccountNo != null and childAccountNo != ''">
                and ea.child_account_no = #{childAccountNo}
            </if>
            <if test="validFlag != null ">
                and ea.valid_flag = #{validFlag}
            </if>
        </where>
    </select>

    <!-- 获取任务数可变更的账户信息列表 -->
    <select id="findTaskModifiableAccountCount" parameterType="org.nmgns.bps.cktj.entity.EmployeeAccount" resultType="java.lang.Long">
        SELECT count(*)
        FROM
            (
                SELECT
                    ea.*,
                    dpfm01.close_acct_flag
                FROM
                    bps_78000.t_cktj_employee_account_task ea
                    LEFT JOIN bps_78000.t_ods_hxsj_deposit_account dpfm01 on dpfm01.account_no = ea.account_no
                    LEFT JOIN public.t_sys_organization o ON o.code = ea.org_code
                <where>
                    ea.valid_flag = true
                    and (ea.register_check_status is null or ea.register_check_status = 'CHECKED_STATUS_CHECKED')
                    and (ea.alter_check_status is null or ea.alter_check_status = 'CHECKED_STATUS_CHECKED')
                    <if test="organizationId != null" >
                        and (o.id = #{organizationId} OR ( o.parent_ids @> CAST(ARRAY[#{organizationId}] AS INTEGER[]) ) )
                    </if>
                    <if test="orgCode != null and orgCode != ''">
                        AND ea.org_code = #{orgCode}
                    </if>
                    <!-- 搜索条件 -->
                    <if test="accountNo != null and accountNo != ''">
                        AND ea.account_no = #{accountNo}
                    </if>
                    <if test="childAccountNo != null and childAccountNo != ''">
                        AND ea.child_account_no = #{childAccountNo}
                    </if>
                    <if test="cardNo != null and cardNo != ''">
                        AND ea.card_no LIKE '%'||#{cardNo}||'%'
                    </if>
                    <if test="customerName != null and customerName != ''">
                        AND ea.customer_name LIKE '%'||#{customerName}||'%'
                    </if>
                    <if test="identityNo != null and identityNo != ''">
                        AND ea.identity_no = #{identityNo}
                    </if>
                    <if test="customerType != null and customerType != ''">
                        AND ea.customer_type = #{customerType}
                    </if>
                    <if test="accountOpenDate != null">
                        AND ea.account_open_date = #{accountOpenDate}
                    </if>
                    <!-- 数据范围过滤 -->
                    ${sqlMap.dsf}
                </where>
            ) t

    </select>

    <!-- 获取任务数可变更的账户信息列表 -->
    <select id="findTaskModifiableAccount" parameterType="org.nmgns.bps.cktj.entity.EmployeeAccount" resultType="org.nmgns.bps.cktj.entity.EmployeeAccount">
        SELECT
            ea.*,
            dpfm01.close_acct_flag
        FROM
            bps_78000.t_cktj_employee_account_task ea
            LEFT JOIN bps_78000.t_ods_hxsj_deposit_account dpfm01 on dpfm01.account_no = ea.account_no
            LEFT JOIN public.t_sys_organization o ON o.code = ea.org_code
        <where>
            ea.valid_flag = true
            and (ea.register_check_status is null or ea.register_check_status = 'CHECKED_STATUS_CHECKED')
            and (ea.alter_check_status is null or ea.alter_check_status = 'CHECKED_STATUS_CHECKED')
            <if test="organizationId != null" >
                and (o.id = #{organizationId} OR ( o.parent_ids @> CAST(ARRAY[#{organizationId}] AS INTEGER[]) ) )
            </if>
            <if test="orgCode != null and orgCode != ''">
                AND ea.org_code = #{orgCode}
            </if>
            <!-- 搜索条件 -->
            <if test="accountNo != null and accountNo != ''">
                AND ea.account_no = #{accountNo}
            </if>
            <if test="childAccountNo != null and childAccountNo != ''">
                AND ea.child_account_no = #{childAccountNo}
            </if>
            <if test="cardNo != null and cardNo != ''">
                AND ea.card_no LIKE '%'||#{cardNo}||'%'
            </if>
            <if test="customerName != null and customerName != ''">
                AND ea.customer_name LIKE '%'||#{customerName}||'%'
            </if>
            <if test="identityNo != null and identityNo != ''">
                AND ea.identity_no = #{identityNo}
            </if>
            <if test="customerType != null and customerType != ''">
                AND ea.customer_type = #{customerType}
            </if>
            <if test="accountOpenDate != null">
                AND ea.account_open_date = #{accountOpenDate}
            </if>
            <!-- 数据范围过滤 -->
            ${sqlMap.dsf}
        </where>
        <choose>
            <when test="page !=null and page.orderBy != null and page.orderBy != ''">
                ORDER BY ${page.orderBy}
            </when>
            <otherwise>
                ORDER BY ea.account_no DESC
            </otherwise>
        </choose>
        <if test="page != null and page.start >= 0 and page.pageSize > 0">
            offset ${page.start} limit ${page.pageSize}
        </if>
    </select>

    <!-- 获取计酬数可变更的账户信息列表 -->
    <select id="findPaymentModifiableAccountCount" parameterType="org.nmgns.bps.cktj.entity.EmployeeAccount"  resultType="java.lang.Long">
        SELECT count(*)
        FROM
        (
            SELECT
                ea.*,
                dpfm01.close_acct_flag
            FROM
                bps_78000.t_cktj_employee_account_payment ea
                LEFT JOIN bps_78000.t_ods_hxsj_deposit_account dpfm01 on dpfm01.account_no = ea.account_no
                LEFT JOIN public.t_sys_organization o ON o.code = ea.org_code
        <where>
            ea.valid_flag = true
            and (ea.register_check_status is null or ea.register_check_status = 'CHECKED_STATUS_CHECKED')
            and (ea.alter_check_status is null or ea.alter_check_status = 'CHECKED_STATUS_CHECKED')
            <if test="organizationId != null" >
                and (o.id = #{organizationId} OR ( o.parent_ids @> CAST(ARRAY[#{organizationId}] AS INTEGER[]) ) )
            </if>
            <if test="orgCode != null and orgCode != ''">
                AND ea.org_code = #{orgCode}
            </if>
            <!-- 搜索条件 -->
            <if test="accountNo != null and accountNo != ''">
                AND ea.account_no = #{accountNo}
            </if>
            <if test="childAccountNo != null and childAccountNo != ''">
                AND ea.child_account_no = #{childAccountNo}
            </if>
            <if test="cardNo != null and cardNo != ''">
                AND ea.card_no LIKE '%'||#{cardNo}||'%'
            </if>
            <if test="customerName != null and customerName != ''">
                AND ea.customer_name LIKE '%'||#{customerName}||'%'
            </if>
            <if test="identityNo != null and identityNo != ''">
                AND ea.identity_no = #{identityNo}
            </if>
            <if test="customerType != null and customerType != ''">
                AND ea.customer_type = #{customerType}
            </if>
            <if test="accountOpenDate != null">
                AND ea.account_open_date = #{accountOpenDate}
            </if>
            <!-- 数据范围过滤 -->
            ${sqlMap.dsf}
        </where>
        ) t

    </select>

    <!-- 获取计酬数可变更的账户信息列表 -->
    <select id="findPaymentModifiableAccount" parameterType="org.nmgns.bps.cktj.entity.EmployeeAccount" resultType="org.nmgns.bps.cktj.entity.EmployeeAccount">
        SELECT
            ea.*,
            dpfm01.close_acct_flag
        FROM
            bps_78000.t_cktj_employee_account_payment ea
            LEFT JOIN bps_78000.t_ods_hxsj_deposit_account dpfm01 on dpfm01.account_no = ea.account_no
            LEFT JOIN public.t_sys_organization o ON o.code = ea.org_code
        <where>
            ea.valid_flag = true
            and (ea.register_check_status is null or ea.register_check_status = 'CHECKED_STATUS_CHECKED')
            and (ea.alter_check_status is null or ea.alter_check_status = 'CHECKED_STATUS_CHECKED')
            <if test="organizationId != null" >
                and (o.id = #{organizationId} OR ( o.parent_ids @> CAST(ARRAY[#{organizationId}] AS INTEGER[]) ) )
            </if>
            <if test="orgCode != null and orgCode != ''">
                AND ea.org_code = #{orgCode}
            </if>
            <!-- 搜索条件 -->
            <if test="accountNo != null and accountNo != ''">
                AND ea.account_no = #{accountNo}
            </if>
            <if test="childAccountNo != null and childAccountNo != ''">
                AND ea.child_account_no = #{childAccountNo}
            </if>
            <if test="cardNo != null and cardNo != ''">
                AND ea.card_no LIKE '%'||#{cardNo}||'%'
            </if>
            <if test="customerName != null and customerName != ''">
                AND ea.customer_name LIKE '%'||#{customerName}||'%'
            </if>
            <if test="identityNo != null and identityNo != ''">
                AND ea.identity_no = #{identityNo}
            </if>
            <if test="customerType != null and customerType != ''">
                AND ea.customer_type = #{customerType}
            </if>
            <if test="accountOpenDate != null">
                AND ea.account_open_date = #{accountOpenDate}
            </if>
            <!-- 数据范围过滤 -->
            ${sqlMap.dsf}
        </where>
        <choose>
            <when test="page !=null ">
                ORDER BY ea.account_no DESC
            </when>
            <otherwise>
                ORDER BY ea.account_no DESC
            </otherwise>
        </choose>
        <if test="page != null and page.start >= 0 and page.pageSize > 0">
            offset ${page.start} limit ${page.pageSize}
        </if>
    </select>

    <!-- 获取已变更揽储人但未复核的账户总数（通过任务分成表加工得到） -->
    <select id="findModifiedUncheckedAccountTaskCount" parameterType="org.nmgns.bps.cktj.entity.EmployeeAccount" resultType="java.lang.Long">
        select count(*)
        from (
                SELECT
                    ea.*,
                    dpfm01.close_acct_flag
                FROM
                    bps_78000.t_cktj_employee_account_task ea
                    LEFT JOIN bps_78000.t_ods_hxsj_deposit_account dpfm01 on dpfm01.account_no = ea.account_no
                    LEFT JOIN public.t_sys_organization o ON o.code = ea.org_code
                <where>
                    ea.valid_flag = false and ea.alter_check_status = 'CHECKED_STATUS_UNCHECKED'
                    <if test="organizationId != null" >
                        AND (o.id = #{organizationId} OR ( o.parent_ids @> CAST(ARRAY[#{organizationId}] AS INTEGER[]) ) )
                    </if>
                    <if test="orgCode != null and orgCode != ''">
                        AND ea.org_code = #{orgCode}
                    </if>
                    <!-- 搜索条件 -->
                    <if test="accountNo != null and accountNo != ''">
                        AND ea.account_no = #{accountNo}
                    </if>
                    <if test="cardNo != null and cardNo != ''">
                        AND ea.card_no LIKE '%'||#{cardNo}||'%'
                    </if>
                    <if test="customerName != null and customerName != ''">
                        AND ea.customer_name LIKE '%'||#{cardNo}||'%'
                    </if>
                    <if test="identityNo != null and identityNo != ''">
                        AND ea.identity_no = #{identityNo}
                    </if>
                    <if test="customerType != null and customerType != ''">
                        AND ea.customer_type = #{customerType}
                    </if>
                    <if test="accountOpenDate != null">
                        AND ea.account_open_date = #{accountOpenDate}
                    </if>
                    <!-- 数据范围过滤 -->
                    ${sqlMap.dsf}
                </where>
             ) t

    </select>

    <!-- 获取已变更揽储人但未复核的账户列表（通过任务分成表加工得到） -->
    <select id="findModifiedUncheckedAccountTask" parameterType="org.nmgns.bps.cktj.entity.EmployeeAccount" resultType="org.nmgns.bps.cktj.entity.EmployeeAccount">
        SELECT
            ea.*,
            dpfm01.close_acct_flag
        FROM
            bps_78000.t_cktj_employee_account_task ea
            LEFT JOIN bps_78000.t_ods_hxsj_deposit_account dpfm01 on dpfm01.account_no = ea.account_no
            LEFT JOIN public.t_sys_organization o ON o.code = ea.org_code
        <where>
            ea.valid_flag = false and ea.alter_check_status = 'CHECKED_STATUS_UNCHECKED'
            <if test="organizationId != null" >
                AND (o.id = #{organizationId} OR ( o.parent_ids @> CAST(ARRAY[#{organizationId}] AS INTEGER[]) ) )
            </if>
            <if test="orgCode != null and orgCode != ''">
                AND ea.org_code = #{orgCode}
            </if>
            <!-- 搜索条件 -->
            <if test="accountNo != null and accountNo != ''">
                AND ea.account_no = #{accountNo}
            </if>
            <if test="cardNo != null and cardNo != ''">
                AND ea.card_no LIKE '%'||#{cardNo}||'%'
            </if>
            <if test="customerName != null and customerName != ''">
                AND ea.customer_name LIKE '%'||#{cardNo}||'%'
            </if>
            <if test="identityNo != null and identityNo != ''">
                AND ea.identity_no = #{identityNo}
            </if>
            <if test="customerType != null and customerType != ''">
                AND ea.customer_type = #{customerType}
            </if>
            <if test="accountOpenDate != null">
                AND ea.account_open_date = #{accountOpenDate}
            </if>
            <!-- 数据范围过滤 -->
            ${sqlMap.dsf}
        </where>
        <choose>
            <when test="page !=null ">
                ORDER BY ea.account_no DESC
            </when>
            <otherwise>
                ORDER BY ea.account_no DESC
            </otherwise>
        </choose>
        <if test="page != null and page.start >= 0 and page.pageSize > 0">
            offset ${page.start} limit ${page.pageSize}
        </if>
    </select>

    <!-- 获取已变更揽储人但未复核的账户总数（通过任务分成表加工得到） -->
    <select id="findModifiedUncheckedAccountPaymentCount" resultType="java.lang.Long">
        select count(*)
        from (
                SELECT
                    ea.*,
                    dpfm01.close_acct_flag
                FROM
                    bps_78000.t_cktj_employee_account_payment ea
                    LEFT JOIN bps_78000.t_ods_hxsj_deposit_account dpfm01 on dpfm01.account_no = ea.account_no
                    LEFT JOIN public.t_sys_organization o ON o.code = ea.org_code
                <where>
                    ea.valid_flag = false and ea.alter_check_status = 'CHECKED_STATUS_UNCHECKED'
                    <if test="organizationId != null" >
                        AND (o.id = #{organizationId} OR ( o.parent_ids @> CAST(ARRAY[#{organizationId}] AS INTEGER[]) ) )
                    </if>
                    <if test="orgCode != null and orgCode != ''">
                        AND ea.org_code = #{orgCode}
                    </if>
                    <!-- 搜索条件 -->
                    <if test="accountNo != null and accountNo != ''">
                        AND ea.account_no = #{accountNo}
                    </if>
                    <if test="cardNo != null and cardNo != ''">
                        AND ea.card_no LIKE '%'||#{cardNo}||'%'
                    </if>
                    <if test="customerName != null and customerName != ''">
                        AND ea.customer_name LIKE '%'||#{cardNo}||'%'
                    </if>
                    <if test="identityNo != null and identityNo != ''">
                        AND ea.identity_no = #{identityNo}
                    </if>
                    <if test="customerType != null and customerType != ''">
                        AND ea.customer_type = #{customerType}
                    </if>
                    <if test="accountOpenDate != null">
                        AND ea.account_open_date = #{accountOpenDate}
                    </if>
                    <!-- 数据范围过滤 -->
                    ${sqlMap.dsf}
                </where>
        ) t

    </select>

    <!-- 获取已变更揽储人但未复核的账户列表（通过任务分成表加工得到） -->
    <select id="findModifiedUncheckedAccountPayment" resultType="org.nmgns.bps.cktj.entity.EmployeeAccount">
        SELECT
            ea.*,
            dpfm01.close_acct_flag
        FROM
            bps_78000.t_cktj_employee_account_payment ea
            LEFT JOIN bps_78000.t_ods_hxsj_deposit_account dpfm01 on dpfm01.account_no = ea.account_no
            LEFT JOIN public.t_sys_organization o ON o.code = ea.org_code
        <where>
            ea.valid_flag = false and ea.alter_check_status = 'CHECKED_STATUS_UNCHECKED'
            <if test="organizationId != null" >
                AND (o.id = #{organizationId} OR ( o.parent_ids @> CAST(ARRAY[#{organizationId}] AS INTEGER[]) ) )
            </if>
            <if test="orgCode != null and orgCode != ''">
                AND ea.org_code = #{orgCode}
            </if>
            <!-- 搜索条件 -->
            <if test="accountNo != null and accountNo != ''">
                AND ea.account_no = #{accountNo}
            </if>
            <if test="cardNo != null and cardNo != ''">
                AND ea.card_no LIKE '%'||#{cardNo}||'%'
            </if>
            <if test="customerName != null and customerName != ''">
                AND ea.customer_name LIKE '%'||#{cardNo}||'%'
            </if>
            <if test="identityNo != null and identityNo != ''">
                AND ea.identity_no = #{identityNo}
            </if>
            <if test="customerType != null and customerType != ''">
                AND ea.customer_type = #{customerType}
            </if>
            <if test="accountOpenDate != null">
                AND ea.account_open_date = #{accountOpenDate}
            </if>
            <!-- 数据范围过滤 -->
            ${sqlMap.dsf}
        </where>
        <choose>
            <when test="page !=null ">
                ORDER BY ea.account_no DESC
            </when>
            <otherwise>
                ORDER BY ea.account_no DESC
            </otherwise>
        </choose>
        <if test="page != null and page.start >= 0 and page.pageSize > 0">
            offset ${page.start} limit ${page.pageSize}
        </if>
    </select>

    <select id="getDepositAccountAutoBindRule" resultType="org.nmgns.bps.system.entity.Dictionary">
        select * from bps_78000.t_branch_dictionary where code like 'DEPOSIT_ACCOUNT_AUTO_BIND_LEVEL_%'
    </select>
</mapper>